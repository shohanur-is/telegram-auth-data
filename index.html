<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Telegram WebApp Auth</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body>
    <button id="send">Send to backend</button>
    <pre id="payload"></pre>
    <pre id="result"></pre>
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const initData = (Telegram.WebApp && Telegram.WebApp.initData) || window.location.search.slice(1);
        const params = initData ? Object.fromEntries(new URLSearchParams(initData)) : {};
        console.log("if params", params.user);
        // Parse user JSON string to object if present
        if (params.user && typeof params.user === 'string') {
          try { params.user = JSON.parse(params.user); } catch (e) {}
        }

        document.getElementById('payload').textContent = JSON.stringify(params, null, 2);

        document.getElementById('send').addEventListener('click', async () => {
          try {
            const res = await fetch('http://localhost:8000/auth/providers/telegram/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(params) // send raw params (with parsed user)
            });
            const data = await res.json();
            document.getElementById('result').textContent = JSON.stringify(data, null, 2);
          } catch (err) {
            document.getElementById('result').textContent = String(err);
          }
        });
      });
    </script>
  </body>
</html>
